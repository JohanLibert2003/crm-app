<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الزيارات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .card-visit {
            background: white;
            border-radius: var(--radius-md);
            border: none;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
            padding: 20px;
        }

        .card-visit:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        /* Side accent based on status */
        .card-visit::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: var(--light);
        }

        .card-visit.status-done::before {
            background: var(--success);
        }

        .card-visit.status-hot::before {
            background: var(--secondary);
        }

        .card-visit.status-visit::before {
            background: var(--primary);
        }

        .meta-icon {
            width: 32px;
            height: 32px;
            background: var(--light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 14px;
        }
    </style>
</head>

<body>

    <!-- Navbar -->
    <nav class="navbar-modern sticky-top bg-white shadow-sm mb-4">
        <div class="container d-flex justify-content-between align-items-center">
            <h5 class="fw-bold m-0 text-dark">
                <i class="fa-solid fa-location-dot me-2 text-primary-custom"></i> سجل الزيارات
            </h5>
            <div class="d-flex gap-2">
                <a href="reports.html" class="nav-pill-btn text-decoration-none">
                    <i class="fa-solid fa-chart-pie"></i> التقارير
                </a>
                <button onclick="logout()" class="nav-pill-btn text-danger">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container" style="max-width: 600px;">
        <!-- Header Info -->
        <div class="d-flex justify-content-between align-items-center mb-4 px-2">
            <div>
                <span class="text-muted small d-block">مرحباً بك،</span>
                <span class="fw-bold h5" id="agentNameDisplay">...</span>
            </div>
            <div class="bg-grad-primary text-white px-3 py-2 rounded-4 shadow-sm">
                <i class="fa-solid fa-clipboard-check me-1"></i> <span id="visitCount">0</span>
            </div>
        </div>

        <!-- Add Visit Modal -->
        <div class="modal fade" id="addVisitModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold text-primary-custom">تسجيل زيارة جديدة</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body pt-4">
                        <form id="visitForm">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="small text-muted fw-bold ms-1">اسم العميل</label>
                                    <input type="text" class="form-control form-control-custom" name="customer"
                                        placeholder="مثال: سوبر ماركت الحمد" required>
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted fw-bold ms-1">رقم الهاتف (واتساب)</label>
                                    <input type="tel" class="form-control form-control-custom" name="phone"
                                        placeholder="01xxxxxxxxx">
                                </div>
                                <div class="col-6">
                                    <label class="small text-muted fw-bold ms-1">النشاط</label>
                                    <select class="form-select form-control-custom" name="activity" maxlength="50"
                                        onchange="checkActivity(this)">
                                        <option value="سوبر ماركت">سوبر ماركت</option>
                                        <option value="صيدلية">صيدلية</option>
                                        <option value="ملابس">ملابس</option>
                                        <option value="مطعم">مطعم</option>
                                        <option value="other">نشاط آخر...</option>
                                    </select>
                                    <input type="text" id="customActivityInput"
                                        class="form-control form-control-custom mt-2" style="display: none;"
                                        placeholder="أدخل اسم النشاط">
                                </div>
                                <div class="col-12">
                                    <label class="small text-muted fw-bold ms-1">النتيجة</label>
                                    <select class="form-select form-control-custom" name="outcome">
                                        <option value="زيارة روتينية" selected>زيارة روتينية (جاري المتابعة)</option>
                                        <option value="مهتم">عميل مهتم (Hot)</option>
                                        <option value="تم البيع">تم البيع (مغلق)</option>
                                        <option value="غير مهتم">غير مهتم</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="small text-muted fw-bold ms-1">ملاحظات</label>
                                    <textarea class="form-control form-control-custom" name="notes"
                                        placeholder="اكتب تفاصيل الزيارة هنا..." rows="2"></textarea>
                                </div>
                            </div>
                            <button type="submit"
                                class="btn bg-grad-primary w-100 mt-4 py-3 rounded-pill text-white fw-bold shadow-sm border-0">
                                <i class="fa-solid fa-save me-2"></i> حفظ الزيارة
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- List -->
        <div id="loader" class="text-center py-5">
            <div class="spinner-border text-primary"></div>
        </div>
        <div id="visitsList" class="pb-5"></div>
    </div>

    <!-- Floating Button -->
    <button class="fab-custom" data-bs-toggle="modal" data-bs-target="#addVisitModal">
        <i class="fa-solid fa-plus"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://fwtvzwzoblkomtcavhxm.supabase.co';
        const supabaseKey = 'sb_publishable_Mueecz_BEvJhV9Ff6MsH9A_VggHGgUO';
        const client = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        // Check Auth on Load
        async function checkAuth() {
            const { data: { session } } = await client.auth.getSession();
            if (!session) {
                window.location.href = 'auth.html';
                return;
            }
            currentUser = session.user;

            // Get Profile Name
            const { data: profile } = await client.from('profiles').select('*').eq('id', currentUser.id).single();
            const name = profile ? profile.full_name : 'المندوب';
            document.getElementById('agentNameDisplay').innerText = name;
            localStorage.setItem('currentAgentName', name); // Store for logic

            loadVisits();
        }

        function checkActivity(select) {
            const customInput = document.getElementById('customActivityInput');
            if (select.value === 'other') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
            }
        }

        async function loadVisits() {
            const list = document.getElementById('visitsList');
            const loader = document.getElementById('loader');
            const urlParams = new URLSearchParams(window.location.search);
            const mandoobFilter = urlParams.get('mandoob');

            try {
                let query = client
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });

                // Optional: Filter if "mandoob" param exists (View as Admin/Manager)
                if (mandoobFilter) {
                    query = query.eq('agent_name', mandoobFilter);
                    document.getElementById('agentNameDisplay').innerText = `عرض زيارات: ${mandoobFilter}`;
                }

                const { data, error } = await query;

                if (error) throw error;

                document.getElementById('visitCount').innerText = `${data.length} زيارات`;
                loader.style.display = 'none';
                list.innerHTML = '';

                if (data.length === 0) {
                    list.innerHTML = `
                        <div class="text-center text-muted mt-5 opacity-50">
                            <i class="fa-solid fa-box-open fa-3x mb-3"></i>
                            <p>لا توجد زيارات مسجلة</p>
                        </div>`;
                    return;
                }

                data.forEach(v => {
                    const date = new Date(v.created_at).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });

                    let badgeClass = 'status-visit';
                    let cardStatusClass = 'status-visit';

                    if (v.visit_outcome === 'تم البيع') { badgeClass = 'status-done'; cardStatusClass = 'status-done'; }
                    else if (v.visit_outcome === 'مهتم') { badgeClass = 'status-hot'; cardStatusClass = 'status-hot'; }
                    else if (v.visit_outcome === 'غير مهتم') { badgeClass = 'status-other'; cardStatusClass = 'status-other'; }

                    const html = `
                        <div class="card-visit ${cardStatusClass}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="fw-bold mb-1 project-title">${v.customer_name}</h6>
                                    <span class="badge bg-light text-muted border fw-normal"><i class="fa-solid fa-store me-1"></i> ${v.activity_type}</span>
                                </div>
                                <span class="status-pill ${badgeClass} cursor-pointer" onclick="updateStatus('${v.id}', '${v.visit_outcome}')" role="button" title="تحديث الحالة">${v.visit_outcome} <i class="fa-solid fa-pen ms-1 small opacity-50"></i></span>
                            </div>
                            
                            ${v.notes ? `<p class="mt-2 mb-2 small text-secondary bg-light p-2 rounded">${v.notes}</p>` : ''}
                            
                            <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top border-light">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="meta-icon"><i class="fa-regular fa-calendar"></i></div>
                                    <small class="text-muted fw-bold" style="font-size: 0.8rem;">${date}</small>
                                </div>
                                ${v.phone ? `
                                    <a href="https://wa.me/2${v.phone.replace(/[^0-9]/g, '')}" target="_blank" class="btn btn-sm btn-success rounded-pill px-3">
                                        <i class="fa-brands fa-whatsapp me-1"></i> واتساب
                                    </a>` : ''}
                            </div>
                            
                            ${!mandoobFilter ? `<div class="mt-2 small text-end text-muted" style="font-size:0.7rem">بواسطة: ${v.agent_name}</div>` : ''}
                        </div>
                    `;
                    list.innerHTML += html;
                });
            } catch (err) {
                console.error(err);
            }
        }

        async function updateStatus(id, currentStatus) {
            const { value: newStatus } = await Swal.fire({
                title: 'تحديث حالة الزيارة',
                input: 'select',
                inputOptions: {
                    'زيارة روتينية': 'زيارة روتينية',
                    'مهتم': 'مهتم (Hot)',
                    'تم البيع': 'تم البيع',
                    'غير مهتم': 'غير مهتم'
                },
                inputValue: currentStatus,
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#2563eb'
            });

            if (newStatus && newStatus !== currentStatus) {
                try {
                    const { error } = await client
                        .from('customers')
                        .update({ visit_outcome: newStatus })
                        .eq('id', id);

                    if (error) throw error;

                    loadVisits();
                    Swal.fire({
                        icon: 'success',
                        title: 'تم التحديث',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                } catch (err) {
                    Swal.fire('خطأ', err.message, 'error');
                }
            }
        }

        // Add Visit
        document.getElementById('visitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'جاري الحفظ...';
            btn.disabled = true;

            const agentName = localStorage.getItem('currentAgentName');

            // Handle Custom Activity
            let finalActivity = form.activity.value;
            if (finalActivity === 'other') {
                finalActivity = document.getElementById('customActivityInput').value;
            }

            const newVisit = {
                agent_id: currentUser.id,
                agent_name: agentName,
                customer_name: form.customer.value,
                phone: form.phone.value,
                activity_type: finalActivity,
                visit_outcome: form.outcome.value,
                notes: form.notes.value,
                status: 'زيارة'
            };

            try {
                const { error } = await client.from('customers').insert([newVisit]);
                if (error) throw error;

                form.reset();
                // Close modal using bootstrap API
                const modal = bootstrap.Modal.getInstance(document.getElementById('addVisitModal'));
                modal.hide();

                loadVisits();
                Swal.fire({
                    icon: 'success',
                    title: 'تم تسجيل الزيارة',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    customClass: { popup: 'rounded-4' }
                });
            } catch (err) {
                Swal.fire('خطأ', err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        async function logout() {
            await client.auth.signOut();
            window.location.href = 'auth.html';
        }

        checkAuth();
    </script>
</body>

</html>